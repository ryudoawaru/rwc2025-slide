# WASHING_PATTERNS è½‰æ›æˆ Parslet è¦å‰‡å¯è¡Œæ€§åˆ†æž

## åŸ·è¡Œæ‘˜è¦

**çµè«–ï¼šä¸å»ºè­°å°‡æ‰€æœ‰ WASHING_PATTERNS è½‰æ›ç‚º Parslet è¦å‰‡**

åŽŸå› ï¼š
1. 54 å€‹æ¨¡å¼ä¸­ï¼Œç´„ 40% æ˜¯**èªžæ„å±¤æ­£è¦åŒ–**ï¼Œå¿…é ˆåœ¨ Transform éšŽæ®µè™•ç†
2. PEG æ–‡æ³•ç„¡æ³•è¡¨é”**å¦å®šå‰çž»/å¾Œé¡§** (negative lookahead/lookbehind)
3. ç›®å‰æž¶æ§‹ï¼ˆParser + Transformï¼‰å·²ç¶“æ˜¯æ­£ç¢ºçš„åˆ†å·¥æ–¹å¼
4. å¼·è¡Œè½‰æ›æœƒè®“ Parser éŽåº¦è¤‡é›œï¼Œå¤±åŽ»å¯è®€æ€§

## åˆ†é¡žçµ±è¨ˆ

```
ç¸½è¨ˆ: 54 å€‹æ¨¡å¼

ã€punctuation_spacingã€‘: 29 å€‹ (53.7%)
  - æ¨™é»žç¬¦è™Ÿå‰å¾ŒåŠ ç©ºæ ¼
  - ä¾‹ï¼š/(.)(",)(.)/ => '\1 \2 \3'

ã€quote_handlingã€‘: 9 å€‹ (16.7%)
  - å¼•è™Ÿè™•ç†
  - ä¾‹ï¼š/''/ => "'"

ã€period_spacingã€‘: 9 å€‹ (16.7%)
  - å¥é»žè™•ç†
  - ä¾‹ï¼š/(\.)([^\.])/ => '\1 \2'

ã€space_normalizationã€‘: 3 å€‹ (5.6%)
  - ç©ºæ ¼æ­£è¦åŒ–
  - ä¾‹ï¼š/\s{2,}/ => ' '

ã€otherã€‘: 4 å€‹ (7.4%)
  - å…¶ä»–ç‰¹æ®Šè™•ç†
```

## å¯è½‰æ›æ€§åˆ†æž

### ðŸ”´ ç„¡æ³•è½‰æ›ç‚º Parslet è¦å‰‡ (Semantic Level - å¿…é ˆä¿ç•™åœ¨ Transform)

#### 1. Space Normalization (3 patterns)
```ruby
/\s{2,}/ => ' '           # å¤šå€‹ç©ºæ ¼å£“ç¸®ç‚ºä¸€å€‹
/â”€\s+?â”€/ => 'â”€â”€'          # é€£å­—ç¬¦ä¹‹é–“çš„ç©ºæ ¼ç§»é™¤
/\(\s([a-zA-Z0-9]+)\s\)/ => '(\1)'  # æ‹¬è™Ÿå…§ç©ºæ ¼ç§»é™¤
```

**åŽŸå› **: é€™äº›æ˜¯**æ­£è¦åŒ–è™•ç†**ï¼Œå±¬æ–¼èªžæ„å±¤æ“ä½œã€‚Parser æ‡‰è©²ä¿ç•™åŽŸå§‹çµæ§‹ï¼Œnormalization åœ¨ Transform éšŽæ®µé€²è¡Œã€‚

#### 2. Negative Lookahead/Lookbehind (ç´„ 15+ patterns)
```ruby
/(\.)([^\.])/ => '\1 \2'      # å¥é»žå¾Œé¢ã€Œä¸æ˜¯ã€å¥é»žæ™‚åŠ ç©ºæ ¼
/([^\.])(\.)/ => '\1 \2'      # å¥é»žå‰é¢ã€Œä¸æ˜¯ã€å¥é»žæ™‚åŠ ç©ºæ ¼
/([^\.])(\.\.\.)\s/ => '\1 \2 '  # å‰é¢ã€Œä¸æ˜¯ã€å¥é»žçš„åˆªç¯€è™Ÿ
/(\"")([^\""])/ => '\1 \2'    # å¼•è™Ÿå¾Œé¢ã€Œä¸æ˜¯ã€å¼•è™Ÿæ™‚åŠ ç©ºæ ¼
```

**åŽŸå› **: PEG æ–‡æ³•ç„¡æ³•è¡¨é”ã€Œä¸æ˜¯ Xã€çš„æ¢ä»¶ï¼ˆnegative lookahead/lookbehindï¼‰ã€‚é€™æ˜¯æ­£å‰‡è¡¨é”å¼çš„å„ªå‹¢ã€‚

#### 3. Position-dependent Patterns (ç´„ 10+ patterns)
```ruby
/^"/ => '" '              # é–‹é ­çš„å¼•è™Ÿ
/'$/ => ' ''              # çµå°¾çš„å¼•è™Ÿ
/^([\(_+=\:;"'~`""\\ã€ã€Œ\?!])/ => '\1 '  # é–‹é ­çš„æ¨™é»ž
/([\)_+=\:;"'~`""\\ã€ã€Œ\?!])$/ => ' \1'  # çµå°¾çš„æ¨™é»ž
```

**åŽŸå› **: é›–ç„¶ Parslet å¯ä»¥ç”¨ `str()` åœ¨å¥é¦–/å¥å°¾åŒ¹é…ï¼Œä½†é€™äº›æ¨¡å¼æ˜¯åœ¨**å·²ç¶“ tokenize ä¹‹å¾Œ**æ‰å¥—ç”¨çš„æ­£è¦åŒ–è¦å‰‡ï¼Œä¸æ˜¯è§£æžéšŽæ®µçš„è¦å‰‡ã€‚

### ðŸŸ¡ éƒ¨åˆ†å¯è½‰æ› (Lexical/Syntax Level - å¯è€ƒæ…®)

#### 1. Punctuation Spacing (ç´„ 20 patterns)
```ruby
/(.)(,)(.)/ => '\1 \2 \3'  # é€—è™Ÿå‰å¾ŒåŠ ç©ºæ ¼
/(.)(:)(.)/ => '\1 \2 \3'  # å†’è™Ÿå‰å¾ŒåŠ ç©ºæ ¼
/(.)(~)(.)/ => '\1 \2 \3'  # æ³¢æµªè™Ÿå‰å¾ŒåŠ ç©ºæ ¼
```

**å¯èƒ½åšæ³•**: åœ¨ Parser éšŽæ®µå°±æŠŠé€™äº›æ¨™é»žè¦–ç‚ºç¨ç«‹ token
```ruby
rule(:comma) { str(',').as(:punct) >> spaces? }
rule(:colon) { str(':').as(:punct) >> spaces? }
```

**ä½†æ˜¯**: é€™æœƒè®“ Parser è¦å‰‡çˆ†ç‚¸ï¼ˆéœ€è¦ç‚ºæ¯å€‹æ¨™é»žå¯«è¦å‰‡ï¼‰ï¼Œè€Œä¸”é€™äº›ã€ŒåŠ ç©ºæ ¼ã€æœ¬è³ªä¸Šæ˜¯**æ ¼å¼åŒ–**ï¼Œä¸æ˜¯**è§£æž**ã€‚

#### 2. Quote Normalization (éƒ¨åˆ†)
```ruby
/''/ => "'"  # å…©å€‹å–®å¼•è™Ÿè®Šä¸€å€‹
```

**å¯èƒ½åšæ³•**: åœ¨ Lexer éšŽæ®µå°±è­˜åˆ¥ä¸¦åˆä½µ
```ruby
rule(:double_quote) { str("''").as(:single_quote) }
```

**ä½†æ˜¯**: é€™æ˜¯**æ­£è¦åŒ–**è€Œéž**è§£æž**ï¼Œæ‡‰è©²åœ¨ Transform è™•ç†ã€‚

### ðŸŸ¢ å·²ç¶“åœ¨ Parser ä¸­è™•ç† (Current Implementation)

```ruby
# ç›®å‰ Parser å·²ç¶“è™•ç†çš„ï¼š
rule(:punctuation) do
  str(',') | str('.') | str('!') | str('?') |
  str(';') | str(':') | str('"') | str("'") |
  str("\u201C") | str("\u201D") | str("\u2018") | str("\u2019")  # Smart quotes
end

rule(:sentence) do
  spaces? >>
  token >>
  (spaces? >> token).repeat >>  # ç©ºæ ¼åˆ†éš”
  spaces?
end
```

é€™äº›å·²ç¶“åœ¨åšï¼š
- è­˜åˆ¥æ¨™é»žç¬¦è™Ÿç‚ºç¨ç«‹ token
- è™•ç† token ä¹‹é–“çš„ç©ºæ ¼
- æ”¯æ´æ™ºæ…§å¼•è™Ÿ

## å»ºè­°æ–¹æ¡ˆ

### âœ… æŽ¨è–¦ï¼šä¿æŒç›®å‰çš„ 3-Phase æž¶æ§‹

```ruby
# Phase 1: Lexical Analysis (Parser è² è²¬)
# - è­˜åˆ¥ words, numbers, punctuation
# - è™•ç†é€£å­—ç¬¦ã€tone marks
# - Tokenization

# Phase 2: Syntax Analysis (Parser è² è²¬)
# - å»ºç«‹ AST
# - ç¢ºèª token é †åº

# Phase 3: Semantic Analysis (Transform è² è²¬)
# - å¥—ç”¨ WASHING_PATTERNS
# - æ­£è¦åŒ–ç©ºæ ¼ã€æ¨™é»ž
# - æ ¼å¼åŒ–è¼¸å‡º
```

**ç›®å‰å¯¦ä½œ**:
```ruby
rule(sentence: sequence(:tokens)) do
  WASHING_PATTERNS.reduce(tokens.join(' ')) do |result, (pattern, replacement)|
    result.gsub(pattern, replacement)
  end.split(/\s/).compact
end
```

é€™å€‹æž¶æ§‹æ˜¯**æ­£ç¢ºçš„**ï¼Parser å°ˆæ³¨æ–¼**çµæ§‹åŒ–**ï¼ˆtokenizationï¼‰ï¼ŒTransform å°ˆæ³¨æ–¼**æ­£è¦åŒ–**ï¼ˆwashingï¼‰ã€‚

### âŒ ä¸æŽ¨è–¦ï¼šå¼·è¡Œè½‰æ›æ‰€æœ‰ Patterns ç‚º Parslet è¦å‰‡

å¦‚æžœè¦é€™æ¨£åšï¼Œä½ æœƒéœ€è¦ï¼š

```ruby
# ç‚ºæ¯å€‹æ¨™é»žå¯«è¦å‰‡
rule(:comma_with_space) { str(',') >> spaces? }
rule(:period_with_space) { str('.').absent?(str('..')) >> spaces? }  # ä½†é€™å€‹åšä¸åˆ°ï¼
rule(:ellipsis) { str('...') >> spaces? }

# ç‚ºæ¯å€‹å¼•è™Ÿçµ„åˆå¯«è¦å‰‡
rule(:open_quote) { str('"') >> spaces? }
rule(:close_quote) { spaces? >> str('"') }

# è™•ç†æ‰€æœ‰é‚Šç•Œæƒ…æ³
rule(:sentence) do
  start_punct.maybe >>
  word_or_number >>
  (
    comma_with_space | period_with_space | colon_with_space |
    # ... éœ€è¦åˆ—èˆ‰æ‰€æœ‰å¯èƒ½çš„çµ„åˆ
  ).repeat >>
  end_punct.maybe
end
```

å•é¡Œï¼š
1. **è¤‡é›œåº¦çˆ†ç‚¸**ï¼šéœ€è¦æ•¸ç™¾è¡Œè¦å‰‡
2. **ç„¡æ³•è¡¨é”å¦å®šæ¢ä»¶**ï¼šPEG åšä¸åˆ°ã€Œå‰é¢ä¸æ˜¯å¥é»žã€
3. **å¤±åŽ»å½ˆæ€§**ï¼šæ–°å¢žä¸€å€‹æ¨™é»žå°±è¦æ”¹ Parser
4. **é•åé—œæ³¨é»žåˆ†é›¢**ï¼šParser ä¸æ‡‰è©²è² è²¬æ ¼å¼åŒ–

## ç›®å‰å•é¡Œçš„çœŸæ­£åŽŸå› 

ç›®å‰ 99.85% fallback çš„åŽŸå› **ä¸æ˜¯** WASHING_PATTERNS çš„å•é¡Œï¼Œè€Œæ˜¯ï¼š

### å•é¡Œï¼šCombining Diacriticals åœ¨å­—æ¯ä¹‹é–“

```
æ–‡å­—: "tsiÌt"
å¯¦éš›ç·¨ç¢¼: t-s-i-Ì-t (combining mark åœ¨ i å’Œ t ä¹‹é–“)

ç›®å‰ Parser å‡è¨­: letter+ diacriticals*
å¯¦éš›éœ€è¦: (letter diacriticals?)+
```

**è§£æ±ºæ–¹æ¡ˆ**ï¼šä¿®æ”¹ `roman_word` è¦å‰‡

```ruby
# ç›®å‰ï¼ˆéŒ¯èª¤ï¼‰
rule(:roman_word) do
  (
    letter.repeat(1) >>
    (hyphen.absent? >> match['\u0300-\u036F']).repeat >>  # å‡è¨­ tone marks åœ¨æœ€å¾Œ
    (hyphen >> ...).repeat
  ).as(:word)
end

# æ‡‰è©²æ”¹ç‚º
rule(:roman_word) do
  (
    (letter >> match['\u0300-\u036F'].repeat).repeat(1) >>  # æ¯å€‹å­—æ¯å¾Œéƒ½å¯èƒ½æœ‰ tone mark
    (hyphen >> (letter >> match['\u0300-\u036F'].repeat).repeat(1)).repeat
  ).as(:word)
end
```

## çµè«–èˆ‡å»ºè­°

### 1. âœ… ä¿æŒ WASHING_PATTERNS åœ¨ Transform éšŽæ®µ
- é€™æ˜¯æ­£ç¢ºçš„æž¶æ§‹è¨­è¨ˆ
- ç¬¦åˆç·¨è­¯å™¨ç†è«–çš„ 3-phase åˆ†é›¢
- æ­£å‰‡è¡¨é”å¼æ¯” PEG æ›´é©åˆè¡¨é”é€™äº› normalization è¦å‰‡

### 2. âœ… ä¿®æ­£ Parser çš„ Combining Diacriticals è™•ç†
```ruby
rule(:letter_with_tone) do
  letter >> match['\u0300-\u036F'].repeat
end

rule(:roman_word) do
  (
    letter_with_tone.repeat(1) >>
    (hyphen >> letter_with_tone.repeat(1)).repeat
  ).as(:word)
end
```

### 3. âœ… ç°¡åŒ– WASHING_PATTERNSï¼ˆå¯é¸ï¼‰
å¦‚æžœè¦ºå¾— 54 å€‹ patterns å¤ªå¤šï¼Œå¯ä»¥åˆ†é¡žæ•´ç†ï¼š

```ruby
SPACE_AROUND_PUNCT = [
  [/(.)(,)(.)/, '\1 \2 \3'],
  [/(.)(;)(.)/, '\1 \2 \3'],
  # ...
].freeze

NORMALIZE_QUOTES = [
  [/''/, "'"],
  [/""/, '"'],
  # ...
].freeze

WASHING_PATTERNS = [
  *SPACE_AROUND_PUNCT,
  *NORMALIZE_QUOTES,
  # ...
].freeze
```

### 4. âœ… RubyWorld Conference 2025 ç°¡å ±é‡é»ž

**æ­£ç¢ºçš„è¨Šæ¯**ï¼š
> "Parser å°ˆæ³¨æ–¼çµæ§‹åŒ–ï¼ˆTokenizationï¼‰ï¼ŒTransform å°ˆæ³¨æ–¼æ­£è¦åŒ–ï¼ˆWashingï¼‰ã€‚
> é€™æ˜¯ç·¨è­¯å™¨ç†è«–çš„ 3-phase åˆ†é›¢åŽŸå‰‡ï¼Œä¹Ÿæ˜¯ Ruby Parser çš„åšæ³•ã€‚
> ä¸æ˜¯æ‰€æœ‰å•é¡Œéƒ½è©²ç”¨ Parser è§£æ±º â€” é¸æ“‡åˆé©çš„å·¥å…·æ‰æ˜¯é—œéµã€‚"

**å±•ç¤ºé‡é»ž**ï¼š
1. Lexical Analysis: è­˜åˆ¥ words, numbers, punctuation
2. Syntax Analysis: å»ºç«‹ token sequence (AST)
3. Semantic Analysis: å¥—ç”¨ WASHING_PATTERNS æ­£è¦åŒ–

**ä¸è¦å¼·èª¿**ï¼š
- ä¸è¦èªªã€ŒParser å¯ä»¥è™•ç†æ‰€æœ‰ WASHING_PATTERNSã€ï¼ˆé€™æ˜¯éŒ¯çš„ï¼‰
- ä¸è¦éŽåº¦è¤‡é›œåŒ– Parserï¼ˆé•åè¨­è¨ˆåŽŸå‰‡ï¼‰

## é™„éŒ„ï¼šPattern è©³ç´°åˆ†é¡ž

### Punctuation Spacing (29 å€‹)
```ruby
/(.)([_+=\:;"'~`""\\ã€ã€Œ\?!])(.)/ => '\1 \2 \3'
/(.)(,)(.)/ => '\1 \2 \3'
/(.)(~)(.)/ => '\1 \2 \3'
/(.)(')(.)/  => '\1 \2 \3'
/(.)(")(.)/ => '\1 \2 \3'
/(.)(ã€)(.)/ => '\1 \2 \3'
/(.)(ã€Œ)(.)/ => '\1 \2 \3'
/(.)(â‹¯â‹¯)/ => '\1 \2'
/(â‹¯â‹¯)(.)/ => '\1 \2'
/(.)(â€¦â€¦)/ => '\1 \2'
/(â€¦â€¦)(.)/ => '\1 \2'
/(.)(ï¼)/ => '\1 \2'
/(ï¼)(.)/ => '\1 \2'
/(.)(ï¼Ÿ)/ => '\1 \2'
/(ï¼Ÿ)(.)/ => '\1 \2'
/(.)(ï¼)/ => '\1 \2'
/(ï¼)(.)/ => '\1 \2'
# ... ç­‰
```

### Quote Handling (9 å€‹)
```ruby
/''/ => "'"
/(.)([_+=\:;"'~`""\\ã€ã€Œ\?!])(.)/ => '\1 \2 \3'
/^([\(_+=\:;"'~`""\\ã€ã€Œ\?!])/ => '\1 '
/([\)_+=\:;"'~`""\\ã€ã€Œ\?!])$/ => ' \1'
/(")([^"])/ => '\1 \2'
/^"/ => '" '
/^'/ => '' '
/'$/ => ' ''
/"$/ => ' "'
```

### Period Spacing (9 å€‹)
```ruby
/(\.)([^\.])/ => '\1 \2'
/([^\.])(\.)/ => '\1 \2'
/\s\.\s\.\s\.$/ => ' ...'
'. ..' => '...'
'.. .' => '...'
/([^\.])(\.\.\.)\s/ => '\1 \2 '
/([^\.])(\.)([^\.])/ => '\1 \2 \3'
/([^\.])(\.\.\.)/ => '\1 \2'
/(\.\.\.)([^\.])/ => '\1 \2'
```

### Space Normalization (3 å€‹)
```ruby
/â”€\s+?â”€/ => 'â”€â”€'
/\(\s([a-zA-Z0-9]+)\s\)/ => '(\1)'
/\s{2,}/ => ' '
```

name: Preview Slides on Pull Request

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - '**.md'
      - '5xruby.css'
      - 'images/**'
      - '.github/workflows/preview-pr.yml'

permissions:
  contents: read
  pull-requests: write

jobs:
  build-preview:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Marp CLI
        run: npm install -g @marp-team/marp-cli

      - name: Generate HTML preview
        run: |
          mkdir -p preview

          # Generate Japanese version (default)
          npx @marp-team/marp-cli slide-ja.md \
            --theme 5xruby.css \
            --html \
            --allow-local-files \
            -o preview/index.html

          # Generate English version
          npx @marp-team/marp-cli slide-en.md \
            --theme 5xruby.css \
            --html \
            --allow-local-files \
            -o preview/slide-en.html

          # Copy assets
          if [ -d "images" ]; then
            cp -r images preview/
          fi

          if [ -f "5xruby.css" ]; then
            cp 5xruby.css preview/
          fi

      - name: Upload preview artifact
        uses: actions/upload-artifact@v4
        with:
          name: slides-preview-pr-${{ github.event.pull_request.number }}
          path: preview
          retention-days: 30

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.issue.number;
            const runId = context.runId;
            const repo = context.repo;

            const comment = `## ğŸ¨ Slide Preview Generated!

            Your presentation slides have been built successfully.

            ### ğŸ“¦ Download Preview
            [Download HTML Preview](https://github.com/${repo.owner}/${repo.repo}/actions/runs/${runId})

            Click the link above, scroll to "Artifacts" section, and download \`slides-preview-pr-${prNumber}\`.

            ### ğŸ“ Details
            - **PR**: #${prNumber}
            - **Branch**: \`${{ github.head_ref }}\`
            - **Commit**: \`${{ github.event.pull_request.head.sha }}\`
            - **Slide files**:
              - Japanese: \`slide-ja.md\` â†’ \`index.html\`
              - English: \`slide-en.md\` â†’ \`slide-en.html\`
            - **Theme**: \`5xruby.css\`

            ### ğŸ”„ Auto-update
            This preview will be updated automatically when you push new commits to this PR.

            ### ğŸš€ After Merge
            Once merged to \`main\`, slides will be automatically deployed to:
            - Japanese (default): https://rwc2025.ryudo.tw
            - English: https://rwc2025.ryudo.tw/slide-en.html
            - Fallback: https://${repo.owner}.github.io/${repo.repo}/

            ---
            *Generated by GitHub Actions*`;

            // Check if we already commented
            const { data: comments } = await github.rest.issues.listComments({
              owner: repo.owner,
              repo: repo.repo,
              issue_number: prNumber,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('ğŸ¨ Slide Preview Generated!')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: repo.owner,
                repo: repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: repo.owner,
                repo: repo.repo,
                issue_number: prNumber,
                body: comment
              });
            }

      - name: Build summary
        run: |
          echo "âœ… Preview build completed for PR #${{ github.event.pull_request.number }}"
          echo "ğŸ“¦ Artifact: slides-preview-pr-${{ github.event.pull_request.number }}"
          echo "â° Retention: 30 days"
